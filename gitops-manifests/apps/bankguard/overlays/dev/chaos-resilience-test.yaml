---
# 1. Augmenter les replicas pour le test
apiVersion: apps/v1
kind: Deployment
metadata:
  name: bankguard-api
  namespace: bankguard-dev
spec:
  replicas: 3  # Augment√© pour le test de r√©silience
---
# 2. Job de chaos test (s'ex√©cute une fois)
apiVersion: batch/v1
kind: Job
metadata:
  name: chaos-resilience-test
  namespace: bankguard-dev
  annotations:
    argocd.argoproj.io/hook: PostSync  # S'ex√©cute apr√®s le sync Argo CD
    argocd.argoproj.io/hook-delete-policy: HookSucceeded  # Se supprime si r√©ussi
spec:
  ttlSecondsAfterFinished: 300  # Supprime apr√®s 5 minutes
  backoffLimit: 0
  template:
    spec:
      serviceAccountName: bankguard-sa
      containers:
      - name: chaos-tester
        image: bitnami/kubectl:latest
        command: ["/bin/bash", "-c"]
        args:
        - |
          echo "üß™ TEST DE R√âSILIENCE - D√âMARRAGE"
          echo "=================================="
          
          # V√©rifier l'√©tat initial
          echo "üìä √âtat initial des pods:"
          kubectl get pods -n bankguard-dev -l app.kubernetes.io/name=bankguard-api
          
          # Tuer un pod al√©atoire
          PODS=$(kubectl get pods -n bankguard-dev -l app.kubernetes.io/name=bankguard-api -o jsonpath='{.items[*].metadata.name}')
          POD_ARRAY=($PODS)
          
          if [ ${#POD_ARRAY[@]} -gt 1 ]; then
            RANDOM_POD=${POD_ARRAY[$RANDOM % ${#POD_ARRAY[@]}]}
            echo "‚ò†Ô∏è Suppression du pod: $RANDOM_POD"
            kubectl delete pod -n bankguard-dev $RANDOM_POD
            
            # Attendre et v√©rifier la reprise
            echo "‚è≥ Attente de la recr√©ation (15s)..."
            sleep 15
            
            echo "üìä √âtat apr√®s chaos:"
            kubectl get pods -n bankguard-dev -l app.kubernetes.io/name=bankguard-api
            
            # V√©rifier que l'app fonctionne toujours
            echo "üîç Test de l'endpoint /health..."
            kubectl run test-pod --image=curlimages/curl --rm -i --restart=Never -- \
              curl -s http://bankguard-service.bankguard-dev.svc.cluster.local/health | grep -o '"status":"[^"]*"' || echo "‚ùå Health check √©chou√©"
            
            echo "‚úÖ Test de r√©silience r√©ussi - Le syst√®me a surv√©cu √† la perte d'un pod"
          else
            echo "‚ö†Ô∏è Pas assez de pods pour le test (minimum 2 requis)"
          fi
          
          echo "=================================="
          echo "üß™ TEST DE R√âSILIENCE - TERMIN√â"
        env:
        - name: KUBECONFIG
          value: /var/run/secrets/kubernetes.io/serviceaccount/.kubeconfig
      restartPolicy: Never
---
# 3. Revenir √† 1 replica apr√®s le test (via annotation pour rollback manuel)
# Note: Vous pouvez faire un git revert pour revenir √† replicas: 1
