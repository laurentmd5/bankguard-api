name: BankGuard DevSecOps CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read
  packages: write
  security-events: write

jobs:
  devsecops:
    runs-on: ubuntu-latest

    steps:
      # ================================
      # 1Ô∏è‚É£ Checkout
      # ================================
      - name: Checkout code
        uses: actions/checkout@v4

      # ================================
      # 2Ô∏è‚É£ D√©finir variables IMAGE
      # ================================
      - name: Set image variables
        run: |
          echo "IMAGE_NAME=ghcr.io/${{ github.repository_owner }}/bankguard-api" >> $GITHUB_ENV
          echo "IMAGE_TAG=dev-${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Show image info
        run: |
          echo "üöÄ Building image:"
          echo "   ${IMAGE_NAME}:${IMAGE_TAG}"

      # ================================
      # 3Ô∏è‚É£ SAST ‚Äì Code Quality & Security
      # ================================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install SAST tools
        run: |
          pip install flake8 bandit

      - name: Lint (flake8)
        run: |
          flake8 app --max-line-length=100

      - name: SAST scan (Bandit)
        run: |
          bandit -r app -ll

      # ================================
      # 4Ô∏è‚É£ Docker Build
      # ================================
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build \
            -t ${IMAGE_NAME}:${IMAGE_TAG} \
            ./app

      # ================================
      # 5Ô∏è‚É£ Image Security Scan (Trivy)
      # ================================
      - name: Trivy scan (FAIL on CRITICAL)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: '${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}'
          format: table
          exit-code: '1'
          severity: CRITICAL
          ignore-unfixed: true

      # ================================
      # 6Ô∏è‚É£ Push image (SAFE ONLY)
      # ================================
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Push Docker image
        run: |
          docker push ${IMAGE_NAME}:${IMAGE_TAG}

      # ================================
      # 7Ô∏è‚É£ Final log
      # ================================
      - name: Pipeline completed
        run: |
          echo "‚úÖ Secure image pushed:"
          echo "   ${IMAGE_NAME}:${IMAGE_TAG}"
