name: BankGuard CI (Minimal)

on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/bankguard-api

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Calculate SHA tags (CRITIQUE pour ArgoCD Image Updater)
      - name: Set image tags
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "SHORT_SHA=${SHORT_SHA}" >> $GITHUB_ENV
          echo "TAG_IMMUTABLE=${SHORT_SHA}" >> $GITHUB_ENV       # a1b2c3d (pour ArgoCD)
          echo "TAG_DEV=dev-${SHORT_SHA}" >> $GITHUB_ENV         # dev-a1b2c3d (backup)

      # 3. Login to GHCR
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. Build and push (3 tags strat√©giques)
      - name: Build and push Docker images
        run: |
          echo "üèóÔ∏è Building image with 3 tags:"
          echo "  1. ${IMAGE_NAME}:${TAG_IMMUTABLE}  (immutable, pour ArgoCD)"
          echo "  2. ${IMAGE_NAME}:${TAG_DEV}        (dev reference)"
          echo "  3. ${IMAGE_NAME}:latest-dev        (fallback)"

          # Build avec les 3 tags
          docker buildx build \
            --push \
            --tag ${IMAGE_NAME}:${TAG_IMMUTABLE} \
            --tag ${IMAGE_NAME}:${TAG_DEV} \
            --tag ${IMAGE_NAME}:latest-dev \
            ./app

      # 5. Verification log
      - name: Verify image push
        run: |
          echo "‚úÖ CI COMPLETED SUCCESSFULLY"
          echo "========================================="
          echo "Images available on GHCR:"
          echo "‚Ä¢ ${IMAGE_NAME}:${TAG_IMMUTABLE}"
          echo "‚Ä¢ ${IMAGE_NAME}:${TAG_DEV}"
          echo "‚Ä¢ ${IMAGE_NAME}:latest-dev"
          echo ""
          echo "üìù ArgoCD Image Updater will detect:"
          echo "   Tag pattern: ^[a-f0-9]{7}$"
          echo "   Will select: ${TAG_IMMUTABLE}"
          echo "========================================="
